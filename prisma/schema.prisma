// Schema Prisma - Sistema Multi-Tenant para Salões de Beleza
// PostgreSQL (Render.com) - Produção
// Multi-Tenant: Todos os dados isolados por salonId

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MODELOS PRINCIPAIS - MULTI-TENANT
// ============================================

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String
  password    String   // bcrypt hash
  role        Role     @default(OWNER)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relacionamentos
  salon        Salon?
  appointments Appointment[]
  
  @@map("users")
}

model Salon {
  id            String        @id @default(cuid())
  name          String
  ownerName     String
  email         String        @unique
  phone         String
  address       String?
  city          String?
  state         String?
  zipCode       String?
  description   String?
  logo          String?
  
  // Licenciamento
  licenseKey    String        @unique
  planType      PlanType      @default(STARTER)
  licenseStatus LicenseStatus @default(ACTIVE)
  expiresAt     DateTime
  maxUsers      Int           @default(5)
  
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Relacionamentos
  ownerId       String        @unique
  owner         User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  clients       Client[]
  services      Service[]
  professionals Professional[]
  appointments  Appointment[]
  transactions  Transaction[]
  workingHours  WorkingHours[]
  integrations  Integration[]
  products      Product[]
  
  @@map("salons")
  @@index([licenseKey])
  @@index([email])
}

model Client {
  id          String        @id @default(cuid())
  name        String
  email       String?
  phone       String
  birthDate   DateTime?
  address     String?
  notes       String?
  preferences String[]
  totalSpent  Decimal       @default(0) @db.Decimal(10, 2)
  totalVisits Int           @default(0)
  lastVisit   DateTime?
  status      ClientStatus  @default(ACTIVE)
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  // Relacionamentos
  salonId     String
  salon       Salon         @relation(fields: [salonId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  
  @@map("clients")
  @@index([salonId])
  @@index([salonId, phone])
}

model Service {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  duration    Int      // minutos
  category    String
  commission  Int      @default(30) // %
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relacionamentos
  salonId      String
  salon        Salon         @relation(fields: [salonId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  
  @@map("services")
  @@index([salonId])
}

model Professional {
  id          String        @id @default(cuid())
  name        String
  email       String?
  phone       String?
  specialties String[]
  commission  Int           @default(30) // %
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  // Relacionamentos
  salonId      String
  salon        Salon         @relation(fields: [salonId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  transactions Transaction[]
  
  @@map("professionals")
  @@index([salonId])
}

model Appointment {
  id            String            @id @default(cuid())
  date          DateTime
  startTime     String
  endTime       String
  status        AppointmentStatus @default(SCHEDULED)
  notes         String?
  totalPrice    Decimal           @db.Decimal(10, 2)
  paymentStatus PaymentStatus     @default(PENDING)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  
  // Relacionamentos
  clientId       String
  client         Client       @relation(fields: [clientId], references: [id])
  serviceId      String
  service        Service      @relation(fields: [serviceId], references: [id])
  professionalId String
  professional   Professional @relation(fields: [professionalId], references: [id])
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  salonId        String
  salon          Salon        @relation(fields: [salonId], references: [id], onDelete: Cascade)
  
  @@map("appointments")
  @@index([salonId])
  @@index([salonId, date])
}

model Transaction {
  id               String          @id @default(cuid())
  type             TransactionType
  amount           Decimal         @db.Decimal(10, 2)
  description      String
  category         String
  paymentMethod    PaymentMethod
  commissionRate   Int?
  commissionAmount Decimal?        @db.Decimal(10, 2)
  appointmentId    String?
  clientName       String?
  serviceName      String?
  date             DateTime        @default(now())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  
  // Relacionamentos
  salonId        String
  salon          Salon         @relation(fields: [salonId], references: [id], onDelete: Cascade)
  professionalId String?
  professional   Professional? @relation(fields: [professionalId], references: [id])
  
  @@map("transactions")
  @@index([salonId])
  @@index([salonId, date])
}

model WorkingHours {
  id        String   @id @default(cuid())
  dayOfWeek Int      // 0-6 (Domingo-Sábado)
  startTime String   // "09:00"
  endTime   String   // "18:00"
  isClosed  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relacionamentos
  salonId   String
  salon     Salon    @relation(fields: [salonId], references: [id], onDelete: Cascade)
  
  @@unique([salonId, dayOfWeek])
  @@map("working_hours")
}

model Integration {
  id        String          @id @default(cuid())
  type      IntegrationType
  isEnabled Boolean         @default(false)
  config    Json            // Configurações específicas de cada integração
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  
  // Relacionamentos
  salonId   String
  salon     Salon           @relation(fields: [salonId], references: [id], onDelete: Cascade)
  
  @@unique([salonId, type])
  @@map("integrations")
}

model Product {
  id          String        @id @default(cuid())
  name        String
  description String?
  category    String
  brand       String?
  price       Decimal       @db.Decimal(10, 2)
  costPrice   Decimal?      @db.Decimal(10, 2)
  stock       Int           @default(0)
  minStock    Int           @default(0)
  unit        String        @default("un") // un, kg, l, etc
  barcode     String?
  status      ProductStatus @default(ACTIVE)
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  // Relacionamentos
  salonId     String
  salon       Salon         @relation(fields: [salonId], references: [id], onDelete: Cascade)
  
  @@map("products")
  @@index([salonId])
  @@index([salonId, category])
  @@index([salonId, status])
}

// ============================================
// SISTEMA DE LICENÇAS
// ============================================

model License {
  id            String          @id @default(cuid())
  licenseKey    String          @unique
  planType      LicensePlanType
  status        LicenseStatus   @default(PENDING)
  clientId      String
  clientName    String
  clientEmail   String
  createdAt     DateTime        @default(now())
  expiresAt     DateTime
  maxUsers      Int
  paymentStatus PaymentStatus   @default(PENDING)
  renewalDate   DateTime?
  updatedAt     DateTime        @updatedAt
  
  // Relacionamentos
  features      LicenseFeature[]
  
  @@map("licenses")
}

model LicenseFeature {
  id          String   @id @default(cuid())
  name        String
  enabled     Boolean  @default(true)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relacionamentos
  licenseId   String
  license     License  @relation(fields: [licenseId], references: [id], onDelete: Cascade)
  
  @@map("license_features")
}

model UserRegistration {
  id          String   @id @default(cuid())
  name        String
  email       String   @unique
  phone       String?
  company     String?
  cnpj        String?
  licenseKey  String?
  totalRevenue Float?  @default(0)
  status      ClientStatus @default(ACTIVE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Endereço
  street      String?
  number      String?
  city        String?
  state       String?
  zipCode     String?
  country     String?
  
  @@map("user_registrations")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  OWNER
  EMPLOYEE
  ADMIN
}

enum PlanType {
  STARTER
  PROFESSIONAL
  PREMIUM
  ENTERPRISE
}

enum LicenseStatus {
  ACTIVE
  TRIAL
  EXPIRED
  SUSPENDED
  PENDING
}

enum LicensePlanType {
  BASIC
  PREMIUM
  ENTERPRISE
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  VIP
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  PIX
  BANK_TRANSFER
}

enum IntegrationType {
  WHATSAPP
  GOOGLE_CALENDAR
  PAYMENT_GATEWAY
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
  DISCONTINUED
}
